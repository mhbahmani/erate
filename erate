#!/bin/bash

connection_check_url="www.tgju.org"
dollar_price_url="https://www.tgju.org/chart/price_dollar_rl"
euro_price_url="https://www.tgju.org/chart/price_eur"
data_backups_dir="$HOME/.local/share/erate"
dollar_price_file="$data_backups_dir/dollar.txt"
euro_price_file="$data_backups_dir/euro.txt"


check_internet_connection(){
        ping -q -w 5 -c 1 $connection_check_url > /dev/null 2>&1 && return 1 || return 0
}

get_price(){
	exchange=$1
	url=$2
	price_file=$3
	check_internet_connection
	if test $? -eq 1; then
		response=$(wget -q -O- $url | grep -E "نرخ فعلی:|زمان ثبت آخرین نرخ:")
		price=$(echo $response | cut -d '>' -f 5 | cut -d '<' -f 1)
		last_update=$(echo $response | cut -d '>' -f 11 | cut -d '<' -f 1)
		show_info $exchange "$price" "$last_update" $price_file
	else
		echo Internet connection failed
		cat $price_file
	fi
}

get_dollar_price(){
	get_price "Dollar" $dollar_price_url $dollar_price_file
}

get_euro_price(){
	get_price "Euro" $euro_price_url $euro_price_file
}

show_info(){
	exchange=$1
	price=$2
	last_update=$3
	price_file=$4
        echo "$exchange: $price" | tee $price_file
        echo "Last Update: $last_update" | tee -a $price_file
}

get_all_exchanges(){
	get_dollar_price
	get_euro_price
}

help(){
	echo 'COMMAND: erate [arguments]

whit no arguments, you can see the all rates.
argumetns:
	`dollar` or `d` for dollar price
	`euro` or `e` for euro price'
}

case $1 in
        dollar | d)
                get_dollar_price
                ;;
	euro | e)
		get_euro_price
                ;;
        --help | -h) 
                help
                ;;
        *)
                get_all_exchanges
		;;
esac
